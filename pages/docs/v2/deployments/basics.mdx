import { withAmp } from 'next/amp'
import Doc from '~/components/layout/docs'
import { TerminalInput } from '~/components/text/terminal'
import { GenericLink } from '~/components/text/link'
import { InlineCode } from '~/components/text/code'
import { Image } from '~/components/media'
import Caption from '~/components/text/caption'
import Card from '~/components/card'
import Note from '~/components/text/note'

export const meta = {
  title: 'Deployment Basics',
  description:
    'Learning the basics of deploying any application with ZEIT Now.',
  editUrl: 'pages/docs/v2/deployments/basics.mdx',
  lastEdited: '2019-07-15T18:40:25.000Z'
}

A deployment represents a copy of your application hosted in our cloud platform, accessible to you and your users via HTTP/2.

The deployment process gets triggered by either an [API call](/docs/api), the `now` command, or `git push` if using our [GitHub integration](/docs/v2/integrations/now-for-github).

The deployment process involves two phases we handle on your behalf:

- Source code synchronization: we take your application sources and upload them.
- Build steps execution: dependent on the filetypes available and your project setup, we detect your project and build it into outputs, ready to serve.

The resulting deployment is:

- [Immutable](/docs/v2/deployments/concepts/immutability)
- [Globally Distributed](/smart-cdn)
- [Serverless](/docs/v2/deployments/concepts/lambdas/#conceptual-model)

## Your First Deployment

In just a few steps, learn how to create your first project using Next.js and a single Node.js endpoint, then deploy it with ZEIT Now without any additional configuration.

The following steps use [Now CLI](/docs/v2/getting-started/installation#now-cli) for an integrated development environment and deployment commands. If you have not installed it yet, please refer to the [installation instructions](/docs/v2/getting-started/installation).

### Step 1: Create a Project

Start by creating a directory for your new project. Open up [your terminal](https://hyper.is) and use the following command:

<TerminalInput>mkdir my-app && cd my-app</TerminalInput>
<Caption>Creating and moving into the <InlineCode>my-app</InlineCode> directory.</Caption>

Next, install the dependencies you are going to use for the frontend:

<TerminalInput>yarn add next react react-dom</TerminalInput>
<Caption>Installing Next.js, React, and React DOM as the project dependencies.</Caption>

Use your text editor to create a `pages/index.js` file with the following contents:

```js
function Home() {
  return (
    <main>
      <h1>Welcome to my website</h1>
      <p>Deployed with ZEIT Now!</p>
      <p>{date ? date : 'Loading date...'}</p>
    </main>
  )
}

export default Home
```

<Caption>A small example Next.js Index page.</Caption>

To have this Next.js app build fresh with every deployment, and for the app to run using the Next.js module in development, add the following script to your `package.json` file (created when installing the dependencies):

```json
{
  "scripts": {
    "build": "next build",
    "dev": "next"
  },
  "dependencies": {...}
}
```

<Caption>
  An example <InlineCode>package.json</InlineCode> with a{' '}
  <InlineCode>scripts</InlineCode> object used to build Next.js for deployment.
</Caption>

### Step 2: Local Development

Now you have a deployment-ready Next.js page, try creating a local development environment using the following command from your terminal (within the project's root directory):

<TerminalInput>now dev</TerminalInput>
<Caption>Using Now CLI to create a development environment that replicates the live deployment environment.</Caption>

<Image
  src={`${process.env.ASSETS}/docs/getting-started/deploying/now-dev.png`}
  width={1526/2}
  height={824/2}
/>
<Caption>A local development server, started with <GenericLink href="/docs/v2/getting-started/installation#now-cli">Now CLI</GenericLink>.</Caption>

### Step 3: Add an API

The power of Now does not stop at building and serving your frontend. Often, you will want to introduce data to your project, and there is no better way to do that than with your own API.

Now supports building anything, using a dynamic language, within an `api` directory as [Serverless Lambdas](/docs/v2/deployments/concepts/lambdas). These are entry points that are invoked when requested (through accessing their URL path), execute code, and respond dynamically.

Get started by creating a function that will be executed whenever the user goes to `/api/date.js`, which will then output the date.

Create a file `api/date.js` with the following contents:

```js
module.exports = (req, res) => {
  const date = new Date().toString()
  res.status(200).send(date)
}
```

<Caption>A Node.js API endpoint to return the current date and time.</Caption>

Using `now dev`, like in [Local Development](#local-development), go to [localhost:3000/api/date](http://localhost:3000/api/date) (unless you were assigned another port due to 3000 being in use, then use that port) and you will see your dynamic date response.

<Note>
  Now automatically ommits the filetype when accessing your API endpoint so you
  don't have to worry about it.
</Note>

<Image
  src={`${process.env.ASSETS}/docs/getting-started/deploying/api-response.png`}
  width={1528/2}
  height={904/2}
/>
<Caption>The new API endpoint showing the date and time from the local development environment.</Caption>

Going one step further, you can even link your frontend to your API and show the latest date when your frontend loads. Change your `pages/index.js` page to the following to make use of your new API:

```js
import { useEffect, useState } from 'react'

function Home() {
  const [date, setDate] = useState(null)

  useEffect(() => {
    async function getDate() {
      const res = await fetch('/api/date')
      const newDate = await res.text()
      setDate(newDate)
    }
    getDate()
  }, [])

  return (
    <main>
      <h1>Welcome to my website</h1>
      <p>Deployed with ZEIT Now!</p>
      <p>{date ? date : 'Loading date...'}</p>
    </main>
  )
}

export default Home
```

<Caption>
  Extending the initial Next.js page with a function to get the date from your
  API.
</Caption>

### Step 4: Deploy

All we have to do now is run `now` from within the `my-app` directory:

<TerminalInput>now</TerminalInput>

The output looks like the following and includes a deployment URL:

<Image
  src={`${process.env.ASSETS}/docs/getting-started/deploying/terminal-deploy.png`}
  width={1526/2}
  height={984/2}
/>
<Caption>The output of deploying a project with <GenericLink href="/docs/v2/getting-started/installation#now-cli">Now CLI</GenericLink>.</Caption>

Check the automatic staging alias for the deployment for a live example: <https://my-app-timothy.now-examples.now.sh/>

<Image
  src={`${process.env.ASSETS}/docs/getting-started/deploying/deployed.png`}
  width={1528/2}
  height={904/2}
/>
<Caption>The output of deploying a project with <GenericLink href="/docs/v2/getting-started/installation#now-cli">Now CLI</GenericLink>.</Caption>

This URL is unique to the source code inside that directory. If you run `now` again, the same deployment is returned. This is why we call our deployments [immutable](/docs/v2/deployments/concepts/immutability).

## Read More

Next, add a domain and assign it as an alias to your new project:

<Card
  title="Introduction to Domains and Aliases"
  href="/docs/v2/domains-and-aliases/introduction"
>
  Add a domain and assign it to a deployment for others to access it through a
  memorable name.
</Card>

export default withAmp(({ children }) => <Doc meta={meta}>{children}</Doc>, {
  hybrid: true
})
